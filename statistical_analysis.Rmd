---
title: "Bacterial nanotubes are a manifestation of cell death: Supplementary Statistical Analysis"
output:
  html_document:
    code_folding: hide
    toc: yes
#  word_document:
#    toc: yes
#  pdf_document:
#    toc: yes
abstract: |+
  This documents contains details of the statistical analysis for the main paper. The analysis is presented here in the same order as the data/figures in the main paper. Code to reproduce the analysis can be found in supplementary files or at https://github.com/cas-bioinf/nanotubes-death.
---

```{r setup_echo, echo = FALSE}
document_output <- (isTRUE(getOption('knitr.in.progress')) &&
                            ("word_document" %in% rmarkdown::all_output_formats(knitr::current_input()) ||
                               "pdf_document" %in% rmarkdown::all_output_formats(knitr::current_input())) )

if(document_output) {
  knitr::opts_chunk$set(echo = FALSE)
}

redo_plots <- TRUE # Set to TRUE to recreate variants of all the figures (originally used to check that the data was loaded correctly)

```


```{r setup, message=FALSE,warning=FALSE}


library(tidyverse)
library(readxl)
library(rstanarm)
library(cowplot)
library(patchwork)
library(Cairo)

theme_set(theme_cowplot())
  theme_update(strip.background = element_rect(fill = "white", colour = "black"), strip.text = element_text(face = "bold"),panel.spacing.x = unit(0, "cm"), panel.border = element_rect(color = "black")) #theme(panel.spacing.x = 0, panel.)

options(mc.cores = parallel::detectCores())

if(redo_plots && !dir.exists("figs")) {
  dir.create("figs")
}

```

# Supplementary Figure 1L - NTs under SEM in varying genetic background

Let us recall the percentage of NTs as shown in the Figure as well as the absolute counts of NTs and cells examined:

```{r}
read_single_sem_quantification <- function(sheet, replicate,  range, condition, file = "FigS1L_Sigmas KOs SEM quantification.xlsx", space = FALSE) {
  if(space) {
    col_types = c("numeric","skip", "numeric")
  } else {
    col_types = c("numeric","numeric")
  }
  read_excel(file, sheet, range = range, col_names = c("Cells","NTs"), col_types = col_types) %>%
    mutate(condition = condition, replicate = replicate, field = 1:n())
}

read_condition_sem_quantification <- function(sheet, cols, rows_from, rows_to, condition = paste0("-",sheet), file = "FigS1L_Sigmas KOs SEM quantification.xlsx", space = FALSE) {
  res <- list()
  for(i in 1:length(rows_from)) {
    res[[i]] <- read_single_sem_quantification(file = file, sheet = sheet, replicate = paste0("E",i), range = 
                                                 paste0(cols[1],rows_from[i],":",cols[2], rows_to[i]), condition = condition,
                                               space = space)
  }
  do.call(rbind, res)
}

data_S1l <- rbind(
  read_condition_sem_quantification("SigD", c("G","H"), rows_from = c(2,19,25,28), rows_to = c(4,19,25,29)),
  read_condition_sem_quantification("SigI", c("H","I"), rows_from = c(2,19,34,50), rows_to = c(4,20,36,51)),
  read_condition_sem_quantification("7ECF", c("H","I"), rows_from = c(2,19,34), rows_to = c(4,22,34)),
  read_condition_sem_quantification("SigB", c("H","I"), rows_from = c(2,19), rows_to = c(4,21)),
  read_condition_sem_quantification("SEM", c("J","K"), condition = "-hag", rows_from = c(2,8,14), rows_to = c(4,11,15), file = "S16d Quantification of NTs in liquid medium.xlsx")
)  

if(redo_plots) {
  data_S1l %>% group_by(condition, replicate) %>%
    summarise(prop_NTs = sum(NTs) / sum(Cells), sumNTs = sum(NTs), sum_cells = sum(Cells), .groups = "drop") %>%
    group_by(condition) %>%
    summarise(perc_NTs_mean = mean(prop_NTs) * 100, perc_NTs_SEM = sd(prop_NTs) / sqrt(n()) * 100, sumNTs = sum(sumNTs), sum_cells = sum(sum_cells), .groups = "drop")
}
```


To compare the conditions, we will use a binomial generalized linear model. Here, we will treat `condition` (the individual knock-outs performed) as the sole covariate. Cells with NTs are treated as success, cells without NTs as failures. Since the $\Delta sigD$ condition has no NTs at all we cannot use the model directly; instead we will try regularizing by adding one success and one failure to each condition and by fitting a Bayesian GLM with weakly informative priors. First the frequentist fit with regularization:


```{r}
data_S1l_fit <- data_S1l %>% mutate(condition = factor(condition, levels = c("-SigD", "-hag","-7ECF","-SigI","-SigB"))) 

fit_S1l_reg <- glm(cbind(NTs + 1, Cells - NTs + 1) ~ condition, data = data_S1l_fit, family = "binomial")
summary(fit_S1l_reg)

```

Above, we have treated the $\Delta sigD$ condition as baseline. None of the contrasts against $\Delta sigD$ is significant and comparing the estimates to errors, we see that other contrasts also are not significant.

To be sure, also the Bayesian fit:

```{r, message=FALSE, results = "hide", cache = TRUE}
fit_S1l_stan <- 
  rstanarm::stan_glm(cbind(NTs, Cells - NTs) ~ condition, family = "binomial", data = data_S1l_fit, 
                     prior_intercept = normal(0,10), prior = normal(0,5))
```

```{r}
summary(fit_S1l_stan, probs = c(0.025, 0.975))

```

Once again, no differences can be deemed significant - however, the data also cannot rule out that the true differences are substantial as witnessed by the wide posterior credible intervals. Importantly, as discussed in [analysis for Supplementary Figure 6](#figS6), when a different microscopic technique was used the effect of the absence of $sigD$ on formation of NTs was significant.


# Figure 1C - Spatial distribution of NTs

The counts of cells on various cell sections are:

```{r}
nt_counts_location_wt <- c("poles" = 75, "septal" = 16, "sides" = 9)
print(nt_counts_location_wt)
```

We will take advantage of the fact that given a uniform prior distribution for the probability of a binary outcome, the  posterior distribution after observing $n$ successes and $k$ failures is $Beta(n + 1, k + 1)$. Quantiles of this distrubition also let us construct a frequentist confidence interval for the proportion.

```{r}
sh1 <-  1 + nt_counts_location_wt["poles"]
sh2 <-  1 + nt_counts_location_wt["septal"] + nt_counts_location_wt["sides"]
posterior_poles <- qbeta(p = c(0.0005,0.9995), sh1,  sh2)
CI_poles <- paste(scales::percent(posterior_poles), collapse = ", ")

p_poles_lt50 <- pbeta(0.5, sh1, sh2)
```

Supposing the distribution of NTs over the surface of the cell is uniform, given the number of NTs we have observed on the poles and elsewhere, the 99.9% posterior CI for the proportion of the cell surface occupied by poles is (`r CI_poles`). Alternatively we have $p = `r p_poles_lt50`$ for the hypothesis of uniformity if poles cover < 50% of the cell surface (which they clearly do).

# Figure 2 - GLG vs. P-GLG

```{r}
read_cell_count_data <- function(file, sheet, prefix) {
  readxl::read_excel(file, sheet = sheet, range = "F1:V4", 
                          col_types = c("text", rep(c("numeric", "skip"), times = 8))) %>%
    rename(Replicate = 1) %>%
    pivot_longer(starts_with(prefix), names_prefix = prefix, names_sep = " t=", names_to = c("category", "time"), values_to = "count") %>%
    mutate(alive = grepl("live", category), 
           alive_string = if_else(alive, "Live", "Dying"),
           alive_string = factor(alive_string, levels = c("Live", "Dying")),
           type = if_else(grepl("NTs", category), "NTs", "cells"),
           category = factor(category, levels = c("live cells", "dying cells", "live cells NTs", "dying cells NTs" ))
           )
}

glg <- read_cell_count_data("Fig.2 chart b", prefix = "Wt ", file = "Fig. 2_Primary data_OB.xlsx") %>% mutate(condition = "GLG")
p_glg <- read_cell_count_data("Fig.2 chart c", prefix = "Wt ", file = "Fig. 2_Primary data_OB.xlsx") %>% mutate(condition = "P-GLG")

fig2_data <- rbind(glg, p_glg)
```


```{r}
# Checking the data was loaded correctly (recreating Fig 2b, c):

if(redo_plots) {
  bar_width <- 0.6
  errorbar_width <- 0.3
  jitter_width <- 0.25
  
  plot_cell_count_data_alive <- function(fig_data, facet = facet_wrap(~condition)) {
    fig_data %>% filter(type == "cells") %>%
      select(-category, -type, -alive) %>%
      pivot_wider(names_from = "alive_string", values_from = "count") %>%
      mutate(fraction_live = Live / (Live + Dying)) %>%
      ggplot(aes(x = time, y = 100 * fraction_live)) + 
      geom_bar(stat = "summary", fun.data = mean_se, width = bar_width, fill = "#f0f0f0", color = "black") + 
      geom_errorbar(stat = "summary", fun.data = mean_se, width = errorbar_width) + 
      geom_point(position = position_jitter(width = jitter_width, height = 0), size = 2) + 
      facet + 
      scale_y_continuous("Percentage of live cells [%]", breaks = 100 * seq(0,1,by = 0.2), limits = c(0,100), expand = c(0,0))
  }
  
  ## Fig 2b
  fig2b <- plot_cell_count_data_alive(fig2_data) + scale_x_discrete("Time [min]")
  print(fig2b)
  
  ggsave("figs/fig2b.pdf", fig2b, device = cairo_pdf, width = 3.2, height = 4)
  
  plot_cell_count_data_NTs <- function(fig_data, facet = facet_wrap(alive_string ~ condition, nrow = 1), group = paste0(alive_string, condition, time), breaks, limits) {
    fig_data %>% 
      select(-category, -alive) %>%
      pivot_wider(names_from = "type", values_from = "count") %>%
      mutate(fraction_NT = NTs / cells) %>%
      group_by({{group}}) %>%
      mutate(all_zero = all(NTs == 0)) %>%
      ggplot(aes(x = time, y = 100 * fraction_NT, color = all_zero )) + 
      geom_bar(stat = "summary", fun.data = mean_se, width = bar_width, fill = "#f0f0f0", color = "black") + 
      geom_errorbar(stat = "summary", fun.data = mean_se, width = errorbar_width) + 
      geom_point(position = position_jitter(width = jitter_width, height = 0), size = 2) + 
      facet + 
      scale_color_manual(values = c("black", "white"), guide = FALSE) +
      scale_y_continuous("Percentage of cells\nwith nanotubes [%]", breaks = breaks, limits = limits, expand = c(0,0))
    
  }

  ## Fig 2c
  fig2c <- plot_cell_count_data_NTs(fig2_data, breaks = seq(0,80,by = 20), limits = c(0,80))
  print(fig2c)
  
  ggsave("figs/fig2c.pdf", fig2c, device = cairo_pdf, width = 5.5, height = 4)

}
```


## Are there more dying cells in P-GLG than in GLG?

For this and similar analysis of positive and negative cases, we will use a binomial generalized linear model. Here, we will treat `condition` (GLG and P-GLG) and `time` (0 or 25 minutes) as covariates. Live cell is treated as success, dying cell as a failure.

```{r}
fit_fig2_dying <- fig2_data %>% filter(type == "cells") %>% 
  select(-category, -alive) %>%
  pivot_wider(names_from = alive_string, values_from = count) %>%
  glm(cbind(Dying, Live) ~ condition * time, family = "binomial", data = .)

summary(fit_fig2_dying)
exp(confint(fit_fig2_dying))
```

Yes. There are significantly more dying cells in the P-GLG (across both times) and at later time (across both conditions) - the `conditionP-GLG` and `time25` rows above. The interaction (`conditionP-GLG:time25`) is not significant, so we cannot be sure whether the number of dying cells increases faster over time in P-GLG or GLG.

## Does P-GLG show more total NTs than GLG?

This is almost the same model as above, except we treat "cell with a NT" as success and "cell without NT" as failure.

```{r}
fig2_data_NT <- fig2_data %>% 
  select(-alive, -alive_string, -type) %>%
  pivot_wider(names_from = category, values_from = count) %>%
  mutate(total_cells = `live cells` + `dying cells`,
         total_NTs = `live cells NTs` + `dying cells NTs`)

fit_fig2_NT <- fig2_data_NT %>%
  glm(cbind(total_NTs, total_cells - total_NTs) ~ condition * time, family = "binomial", data = .)

summary(fit_fig2_NT)
```

Fitting the full model with interaction turns out to be problematic because for the GLG condition at t = 0 we do not see any NTs in any replicate and the model becomes not well identified. There are multiple alternative approaches, first we can simply add 1 cell with NT to all conditions (note that this should reduce the between group differences):

```{r}
fit_fig2_NT_p1 <- fig2_data_NT %>%
  glm(cbind(total_NTs + 1, total_cells - total_NTs + 1) ~ condition * time, family = "binomial", data = .)

summary(fit_fig2_NT_p1)
exp(confint(fit_fig2_NT_p1))
```

This leaves us with a significant difference for the P-GLG condition. Alternatively, we can fit a fully Bayesian model with mild regularization using RStanArm.

```{r, message=FALSE, results = "hide", cache = TRUE}
fit_fig2_NT_stan <- fig2_data_NT %>%
  rstanarm::stan_glm(cbind(total_NTs, total_cells - total_NTs) ~ condition * time, family = "binomial", data = ., 
                     prior_intercept = normal(0,10), prior = normal(0,5),
                     warmup = 1000, iter = 6000) # Large number of iterations to accurately sample tails of the distributions
```

```{r}
summary(fit_fig2_NT_stan, probs = c(0.005,0.025, 0.975,0.995))

```


In this scenario, the 99% posterior credible interval (from 0.5% to 99.5%) for `conditionP-GLG` excludes 0, which is similar to p < 0.01 in the frequentist context. Similarly for the effect of time, but as in the previous case, we do not get a definitive answer whether the increase in NTs over time is different between the two conditions.

Finally, we can also look solely at the t=25 time point and treat only condition as covariate:

```{r}
fit_fig2_NT_25 <- fig2_data_NT %>%
  filter(time == "25") %>%
  glm(cbind(total_NTs, total_cells - total_NTs) ~ condition, family = "binomial", data = .)

summary(fit_fig2_NT_25)
```

Here the difference is very strong.

## Do dying cells produce more NTs in P-GLG than in GLG?

Here, we treat dying cells with NTs as success and dying cells without NTs as failure.

```{r}
fig2_data_NT_dying <-  fig2_data %>% filter(!alive) %>% 
  select(-category) %>%
  pivot_wider(names_from = type, values_from = count)

fit_fig2_NT_dying <- fig2_data_NT_dying  %>%
  glm(cbind(NTs, cells - NTs) ~ condition * time, family = "binomial", data = .)

summary(fit_fig2_NT_dying)
```

Here we have the same problem as in the previous case and we need to regularize/fit a smaller model. Starting with adding 1 NT to all conditions:

```{r}
fit_fig2_NT_dying_p1 <- fig2_data_NT_dying  %>%
  glm(cbind(NTs + 1, cells - NTs + 1) ~ condition * time, family = "binomial", data = .)

summary(fit_fig2_NT_dying_p1)
```

This is also inconclusive. So we will look only at t = 25:

```{r}
fit_fig2_NT_dying_25 <- fig2_data_NT_dying  %>%
  filter(time == "25") %>% 
  glm(cbind(NTs, cells - NTs) ~ condition, family = "binomial", data = .)

summary(fit_fig2_NT_dying_25)
```

Even after this restriction, the data are not conclusive (p > 0.1). We therefore cannot be sure if dying cells produce NTs at higher _rate_ in the P-GLG condition than in the GLG condition. (We are not running the RStanArm model here as even if it contradicted the results here, it would not still lead to strong evidence for the statement).

## Summary

There is good evidence that there are more dying cells and more cells with NTs  in the P-GLG condition (p < 0.001 and p = 0.04 respectively), but it is not clear whether a single dying cell is more likely to have NTs in the P-GLG condition.

# Supplementary Figure 6 A,B - Frequency of NT formation in $\Delta sigD$ {#figS6}


```{r}
data_S6ab <- read_cell_count_data("Fig. S6_Primary data_OB.xlsx", sheet = "Fig S6 chart ab", prefix = "SigD ") %>%
  mutate(condition = "-SigD P-GLG")

#Recreate figures S6a,b to check if the data were loaded correctly:
if(redo_plots) {
  plot6a <- plot_cell_count_data_alive(data_S6ab, NULL) + expand_limits(y = 1)
  plot6b <- plot_cell_count_data_NTs(data_S6ab, facet_wrap(~alive_string), group = alive_string, breaks = seq(0,10, by = 2), limits = c(0,10)) + expand_limits(y = 0.1)
  print(plot6a + plot6b)
  
  ggsave("figs/figS6a.pdf", plot6a, device = cairo_pdf, width = 3.2, height = 4)
  ggsave("figs/figS6b.pdf", plot6b, device = cairo_pdf, width = 5.5, height = 4)

}
```


Is the the frequency of NT formation in $\Delta sigD$ (at 90 min)  lower than in wt (at 25 min)? (both P-GLG). Let us look at the ratio of cells with NTs among all cells and among dying cells:

```{r}
wt_sigD_data <- 
  rbind(data_S6ab, p_glg) %>%
  mutate(condition = factor(condition, levels = c("P-GLG","-SigD P-GLG"))) %>%
  filter(time != "0") %>%
  select(-alive, -alive_string, - type) %>% 
  pivot_wider(names_from = category, values_from = count) %>%
  mutate(total_cells = `live cells` + `dying cells`,
         total_NTs = `live cells NTs` + `dying cells NTs`)

```


```{r}
wt_sigD_data %>% group_by(condition) %>% summarise(ratio_NT_all = sum(total_NTs) / sum(total_cells), ratio_NT_dying = sum(`dying cells NTs`) / sum(`dying cells`), .groups = "drop")
```

First, we examine the proportion of NTs across all cells, _i. e._ cells with NTs are treated as success while cells without NTs are treated as failures in a binomial generalized linear model:

```{r}
fit_wt_sigD_NT <- wt_sigD_data %>%
  glm(cbind(total_NTs, total_cells - total_NTs) ~ condition, family = "binomial", data = .)

summary(fit_wt_sigD_NT)
exp(confint(fit_wt_sigD_NT))
```

Here, we get a significantly lower rate of overall NT formation in $\Delta sigD$ (p < 0.001).

Now let us look at the proportion of NTs in dying cells only, _i. e._ dying cells with NTs are treated as success and dying cells without NTs are treated as failures:

```{r}
fit_wt_sigD_NT_dying <- wt_sigD_data %>%
  glm(cbind(`dying cells NTs`, `dying cells` - `dying cells NTs`) ~ condition, family = "binomial", data = .)

summary(fit_wt_sigD_NT_dying)
```

If we look at the dying cells only, we also have a significantly lower rate of NT formation in $\Delta sigD$. To summarise, the frequency of NT formation in $\Delta sigD$ (at 90 min) appeared to be lower than in wt P-GLG (at 25 min) (all p < 0.001).

## Differences within the $\Delta sigD$ condition

Are the differences over time and conditions in the $\Delta sigD$ condition significant?

```{r}
data_within_sigD <-  data_S6ab %>%
  select(-alive, -alive_string, - type) %>% 
  pivot_wider(names_from = category, values_from = count)

fit_sigD_live_cells <- data_within_sigD %>% 
  glm(cbind(`live cells`, `dying cells`) ~ time, family = "binomial", data = .)

summary(fit_sigD_live_cells)
exp(confint(fit_sigD_live_cells))
```

The proportion of live cells decreases significantly at t = 90 (p < 0.001).

There are no NTs from live cells, but we can look at NTs from dying cells. 

```{r}
fit_sigD_NTs_dying <- data_within_sigD %>%  
  glm(cbind(`dying cells NTs`, `dying cells` - `dying cells NTs`) ~ time, family = "binomial", data = .)

summary(fit_sigD_NTs_dying)
```

The proportion of NTs from dying cells at t=0 is lower than the proportion at t = 90, but the difference is not significant.


Finally, we can look at the difference in percentage of NTs between live and dying cells only at t = 90. Similarly to previous fits where one condition is all zeroes, we add 1 to all counts to regularize.


```{r}
fit_sigD_NTs <- data_S6ab %>%
  filter(time == 90) %>%
  select(-alive_string, -time, -type) %>%
  mutate(category = str_remove(as.character(category), "live |dying ")) %>%
  mutate(count = count + 1, alive = factor(alive, levels = c(TRUE, FALSE))) %>%
  pivot_wider(names_from = category, values_from = count) %>%
  glm(cbind(`cells NTs`, cells - `cells NTs`) ~ alive, data = ., family = "binomial")


summary(fit_sigD_NTs)
exp(confint(fit_sigD_NTs))
```

With this regularization we can say that dying cells produced significantly more NTs than living cells (p = 0.03).

# Supplementary Figure 6 D,E - Frequency of NT formation in $\Delta lytEF$

Now we will do the same analysis as we did for $\Delta sigD$, but using data for $\Delta lytEF$. 

```{r}

data_S6de <- read_cell_count_data("Fig. S6_Primary data_OB.xlsx", sheet = "Fig S6 chart de", prefix = "LytEF ") %>% mutate(condition = "-lytEF P-GLG")

#Recreate figures S6d,e to check if the data were loaded correctly.
if(redo_plots) {
  figS6d <- plot_cell_count_data_alive(data_S6de, NULL) + expand_limits(y = 1)
  figS6e <- plot_cell_count_data_NTs(data_S6de, facet_wrap(~alive_string), group = paste0(alive_string, time), breaks = seq(0,3.5, by = 0.5), limits = c(0,3.5)) 
  figS6d + figS6e
  
  ggsave("figs/figS6d.pdf", figS6d, device = cairo_pdf, width = 3.2, height = 4)
  ggsave("figs/figS6e.pdf", figS6e, device = cairo_pdf, width = 5.5, height = 4)

}
```


```{r}
wt_lytEF_data <- 
  rbind(data_S6de, p_glg) %>%
  mutate(condition = factor(condition, levels = c("P-GLG","-lytEF P-GLG"))) %>%
  filter(time != "0") %>%
  select(-alive, -alive_string, - type) %>% 
  pivot_wider(names_from = category, values_from = count) %>%
  mutate(total_cells = `live cells` + `dying cells`,
         total_NTs = `live cells NTs` + `dying cells NTs`)

```


```{r}
wt_lytEF_data %>% group_by(condition) %>% summarise(ratio_NT_all = sum(total_NTs) / sum(total_cells), ratio_NT_dying = sum(`dying cells NTs`) / sum(`dying cells`), .groups = "drop")
```

First, let us look at the proportion of NTs across all cells:

```{r}
fit_wt_lytEF <- wt_lytEF_data %>%
  glm(cbind(total_NTs, total_cells - total_NTs) ~ condition, family = "binomial", data = .)

summary(fit_wt_lytEF)
exp(confint(fit_wt_lytEF))
```

NTs are formed at a significantly lower rate in $\Delta lytEF$ (p < 0.001).

Now let us look at the proportion of NTs in dying cells only:

```{r}
fit_wt_lytEF_NT_dying <- wt_lytEF_data %>%
  glm(cbind(`dying cells NTs`, `dying cells` - `dying cells NTs`) ~ condition, family = "binomial", data = .)

summary(fit_wt_lytEF_NT_dying)
```

If we look at the dying cells only, we also have a significantly lower rate in $\Delta lytEF$. To summarise, the frequency of NT formation in $\Delta lytEF$ (at 90 min) appeared to be lower than in wt P-GLG (at 25 min) (all p < 0.001).


## Differences within the $\Delta lytEF$ condition


```{r}
data_within_lytEF <-  data_S6de %>%
  select(-alive, -alive_string, - type) %>% 
  pivot_wider(names_from = category, values_from = count)

fit_lytEF_live_cells <- data_within_lytEF %>% 
#  glm(cbind(`live cells`, `dying cells`) ~ time, family = "binomial", data = .)
  glm(cbind(`live cells`, `dying cells`) ~ time, family = "binomial", data = .)

summary(fit_lytEF_live_cells)
exp(confint(fit_lytEF_live_cells))
```

The proportion of live cells decreases significantly at t = 90 (p < 0.001).


There are very few NTs overall, and many conditions contain only zero, so we will once again add 1 to all conditions for regularization. First we look at NTs from dying cells. 

```{r}
fit_lytEF_NTs_dying <- data_within_lytEF %>%  
  mutate(`dying cells NTs` = `dying cells NTs` + 1) %>%
  glm(cbind(`dying cells NTs`, `dying cells` - `dying cells NTs`) ~ time, family = "binomial", data = .)

summary(fit_lytEF_NTs_dying)
exp(confint(fit_wt_lytEF))

```

The proportion of NTs from dying cells at t=0 is not significantly different from the proportion at t = 90.


Finally, we can look at the difference in percentage of NTs between live and dying cells at t = 90. 


```{r}
fit_lytEF_NTs <- data_S6de %>%
  filter(time == 90) %>%
  select(-alive_string, -time, -type) %>%
  mutate(category = str_remove(as.character(category), "live |dying ")) %>%
  mutate(count = count + 1, alive = factor(alive, levels = c(TRUE, FALSE))) %>%
  pivot_wider(names_from = category, values_from = count) %>%
  glm(cbind(`cells NTs`, cells - `cells NTs`) ~ alive, data = ., family = "binomial")


summary(fit_lytEF_NTs)
exp(confint(fit_lytEF_NTs))
```

With this regularization we can say that dying cells produced signicantly more NTs than living cells (p < 0.01).

# Figure 4 - Plasmid transfer

## Transfer and DNase treatments

In the following, we need to work on the log scale for better visualisation, however the data contain conditions with 0 transformations. To handle this data easily, we add 1 transformation to all conditions.

```{r}
read_dnase_subset <- function(file, sheet, range, condition) {
    readxl::read_excel(file, sheet = sheet, range = range,
                     col_types = c("text", "numeric", "skip","numeric", "skip", "numeric"), 
                     col_names = c("replicate", "baseline", "dnase", "recipients")) %>% 
    mutate(condition = condition)

}

read_fig4_subset <- function(range, condition) {
  read_dnase_subset(file = "Fig. 4_Primary data_OB.xlsx", sheet = "Fig.4 chart b", range = range, condition = condition)
}

fig4_data <- rbind(
  read_fig4_subset("A8:F10", "wt"),
  read_fig4_subset("L8:Q10", "-sigD"),
  read_fig4_subset("W8:AB10", "Phs-comK"),
  read_fig4_subset("AH8:AM10", "-comK")
) %>% 
  pivot_longer(cols = c("baseline", "dnase"), names_to = "dnase", values_to = "transformations") %>%
  mutate(
    has_transformations = transformations > 0,
    transformations = 1 + transformations,
    recipients_100 = recipients / 100, ratio = transformations / recipients, ratio_100 = transformations / recipients_100, condition = factor(condition, levels = c("wt","-sigD","Phs-comK", "-comK") ))



# Loading the data and checking that I can reproduce the figures. We replace conditions having 0 transformations with 1s to avoid taking the log of 0. We also show only the DNAse- conditions (all the DNAse+ conditions have 0 transformations).
if(redo_plots) {
  
    bar_base <- 3e-4
  #breaks <- 1e-4 * 2.5^(0:4)
  breaks <- 3e-4 * 10^(0:4)
  
  # Fake bars on log scale
  data_tile <- fig4_data %>%
    rename(has_trans_orig = has_transformations) %>%
    group_by(dnase, condition) %>%
    summarise(
      has_transformations = any(has_trans_orig),
      height = if_else(has_transformations, mean(ratio_100) - bar_base, 0),
      ymax = if_else(has_transformations, mean(log(ratio_100)), log(bar_base)),
      ratio_100 = exp(ymax)
      )

  fig4b <-  fig4_data %>% 
    mutate(ratio_100 = if_else(has_transformations, ratio_100, 1e-2)) %>% #dummy value to not affect the y scale
    ggplot(aes(x = interaction(dnase, condition), y = log(ratio_100), fill = has_transformations, color = has_transformations)) + 
    
    geom_rect(data = data_tile, aes(ymax = ymax, xmin = ..x.. - bar_width / 2, xmax = ..x.. + bar_width /  2), ymin = log(bar_base)) + 
    geom_errorbar(stat = "summary", fun.data = mean_se, width = errorbar_width) + 
    geom_point(position = position_jitter(width = jitter_width, height = 0), size = 2) + 
    
    scale_color_manual(values = c("white","black"), guide = FALSE) +
    scale_fill_manual(values = c("white","#f0f0f0"), guide = FALSE) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3), panel.border = element_rect(color = NA)) + 
    scale_y_continuous("CFU/ml [%] of transformable cells", breaks = log(breaks), labels = breaks, expand = c(0,0)) +
    expand_limits(y = log(6))


  
  print(fig4b)
  ggsave("figs/fig4b.pdf", fig4b, device = cairo_pdf, width = 4.5, height = 4.5)
}

# fig4_data %>% filter(dnase == "baseline") %>% 
#   group_by(condition) %>% 
#   summarise(mean_ratio = mean(ratio_100), sd_ratio = sd(ratio_100)) %>%
#   ggplot(aes(x = condition, y = mean_ratio, ymin = mean_ratio - sd_ratio, ymax = mean_ratio + sd_ratio)) + geom_linerange() + geom_point(stat = "identity") + scale_y_log10()
```

Here we use the data shown in Figure 4b. We will model the logarithm of the ratio of transformations + 1 with a normal linear model with condition and DNase presence/absence as covariates (including their interaction).

```{r}
fit_fig4_all <- fig4_data %>%
  mutate() %>%
  lm(log(ratio_100) ~ condition * dnase, data = .)

summary(fit_fig4_all)
xx <- TukeyHSD(aov(fit_fig4_all))
```

All interesting pairwise comparisons are significant even after adjustments for multiple testing. The exceptions are:

- The DNase+  conditions are not meaningfully different from each other
- The `-comK` condition is not meaningfully different from all the `DNase+` conditions

Otherwise all p < 0.001.


## $comK$ expression.

```{r}
data_fig4c <- readxl::read_excel("Fig. 4_Primary data_OB.xlsx", sheet = "Fig.4 chart c", range = "C2:G4",
                                 col_names = c("replicate","wt","-sigD", "Phs-comK", "-comK")) %>%
  pivot_longer(!one_of("replicate"), names_to = "condition", values_to = "relative_expression") %>%
  mutate(condition = factor(condition, levels = c("wt","-sigD","Phs-comK", "-comK") ))
  

#First let us reproduce the figure:
if(redo_plots) {
  data_fig4c %>% ggplot(aes(x = condition, y = relative_expression)) + stat_summary(fun.data = mean_se) + scale_y_log10()
}

```

We will model the logarithm of the relative expression with a normal linear model, with condition as the only covariate.

```{r}
fit_fig4c <- data_fig4c %>% 
  lm(log(relative_expression / 100) ~ condition, data = .)

summary(fit_fig4c)
TukeyHSD(aov(fit_fig4c))
```

Except for the "$\Delta sigD$ vs. wt" pair, all conditions are statistically significantly different from each other at p < 0.001. 

## Correlation between $comK$ expression and plasmid transfer


```{r}
data_cor <- data_fig4c %>% mutate(replicate = if_else(replicate == "E4", "E1", replicate)) %>%   
  inner_join(fig4_data %>% filter(dnase == "baseline"), by = c("condition", "replicate")) %>%
  mutate(ratio = if_else(condition == "-comK", 1 / recipients, ratio)) %>%
  mutate(log_ratio = log10(ratio), log_expression = log(relative_expression),
         condition = factor(condition, levels = c("wt","-sigD", "-comK", "Phs-comK")))

if(redo_plots) {
  plot_corr <- data_cor %>% 
    ggplot(aes(x = relative_expression, y = ratio * 1e6, shape = condition, color = condition, group = 1)) + 
    geom_vline(xintercept = 100, linetype = "dashed", size = 2, color = "gray") +
    geom_smooth(method = "lm", formula = y ~ x, show.legend=FALSE) + 
    geom_point(size = 3, position = position_jitter(width = 0.1)) +
    scale_x_log10("Relative comK expression", breaks = c(0.01, 1, 100, 10000), labels = c("0.01%", "1%", "100%","10000%") ) + scale_y_log10("Transformable per million cells", breaks = c(1, 100, 10000), labels = as.character) +
    scale_color_brewer(type = "qual", palette = 6) + theme(legend.title = element_blank())
  
  print(plot_corr)
  ggsave("plot_corr.svg", plot_corr)
  
  inkscape_path <-'C:/Program Files/Inkscape/inkscape.exe'
  if(!file.exists(inkscape_path)) {
    warning("Could not find inkscape, will not convert to .emf")
  } else {
     input_file <- "plot_corr.svg"
     output_file <- "plot_corr.emf"
     system(paste0('"', inkscape_path,'"', ' --file "', input_file, '" --export-emf "', output_file, '"'))
  }
}
```

We run Pearson's correlation test on the combination of relative expression and :

```{r}
cor_test_result <- cor.test(data_cor$log_ratio, data_cor$log_expression)

cor_test_result

cor_confint <- cor_test_result$conf.int
```

The transfer was quantitatively correlated with the expression of the comK gene (Fig. 4c, p < 0.001, Pearson's correlation 95% CI = (`r round(cor_confint, 2)`)). 




# Supplementary Figure 8-12 - Antibiotic treatments


```{r}
read_single_receptive_field <- function(sheet, row, column) {
  file <- "Fig.S8_9_11_12_Primary data_OB.xlsx"
  
  col_num_to_letter <- function(x) {
    if(x > 26) {
      if(x > 26*26) {
        print(x)
        stop("Not implemented")
      }
      paste0(c(LETTERS[floor((x - 1) / 26)], LETTERS[((x - 1) %% 26) + 1]), collapse = "")
    } else {
      LETTERS[x]
    }
  }
  
  to_range <- function(start_col_num, start_row, end_col_num, end_row) {
    paste0(c(col_num_to_letter(start_col_num), start_row,":",col_num_to_letter(end_col_num), end_row), collapse = "")
  }
  
  cols_per_field <- 6
  start_col_num <- (column - 1) * cols_per_field + 1
  end_col_num <- start_col_num + cols_per_field - 1
  
  rows_per_field <- 7
  start_row <- (row - 1) * rows_per_field + 1
  end_row <- start_row + rows_per_field - 1
  
  range_title <- to_range(start_col_num, start_row, start_col_num, start_row + 2)
  
  title_data <- readxl::read_excel(file, sheet = sheet, range = range_title, col_names = "data")
  condition <- title_data$data[1]
  replicate_field <- title_data$data[2]
  replicate_field_split <- str_split(replicate_field, " ", simplify = TRUE)
  replicate <- replicate_field_split[1]
  field <- replicate_field_split[3]
  
  main_range <- to_range(start_col_num, start_row + 3,end_col_num, end_row)
  
  readxl::read_excel(file, sheet = sheet, range = main_range, col_names = c("category", "modifier", paste0("time", c(0, 30, 60, 90))),
                     col_types = c("text", "text", rep("numeric", 4))) %>%
    pivot_longer(starts_with("time"), names_to = "time", names_prefix = "time", values_to = "count") %>%
    mutate(category = paste(trimws(category), trimws(replace_na(modifier, ""))), condition = condition, field = field, replicate = replicate) %>% 
    select(-modifier)
}

read_all_receptive_fields <- function(sheet, fields_per_row) {
  if(length(fields_per_row) != 3) {
    stop("Expected three rows")
  }
  res <- list()
  next_id <- 1
  for(row in 1:length(fields_per_row)) {
    for(field in 1:fields_per_row[row]) {
      res[[next_id]] <- read_single_receptive_field(sheet, row, field)
      next_id <- next_id + 1
    }
  }
  do.call(rbind, res)  
}

data_S8_12 <- rbind(
  read_all_receptive_fields("Fig.S8 charts", c(3,3,3)),
  read_all_receptive_fields("Fig.S9 charts", c(5,5,5)),
  read_all_receptive_fields("Fig.S11 charts", c(2,2,2)),
  read_all_receptive_fields("Fig.S12 charts", c(3,2,2))
)  %>%
  mutate(category = factor(trimws(category), levels = c("Live cells", "Dying cells", "Live cells NTs", "Dying cells NTs"), labels = c("live cells", "dying cells", "live cells NTs", "dying cells NTs" )),
         condition = factor(condition, levels = c("Empty LB", "Amp500", "Cm5", "Rif")))
```


```{r}
#First let us recreate all the b) panels - each dot is a single receptive field, the errorbar shows mean +/- standard error.

if(redo_plots) {
  data_S8_12 %>% 
    filter(category == "live cells" | category == "dying cells") %>%
    group_by(condition) %>%
    summarise(total_cells = sum(count))


  data_S8_12 %>% 
    filter(!grepl("NTs", category)) %>%
    pivot_wider(names_from = "category", values_from = "count") %>%
    mutate(ratio_alive = `live cells` / (`live cells` + `dying cells`)) %>%
    ggplot(aes(x = time, y = ratio_alive)) +
      geom_point(position = position_jitter(width = 0.3), alpha = 0.5) + 
      geom_errorbar(stat = "summary", fun.data = mean_se) + 
      facet_wrap(~condition) + 
      scale_y_continuous(labels = scales::percent)
}
```


```{r}
#Now the same for the c) panels:
if(redo_plots) {
  data_S8_12 %>% 
    mutate(alive = grepl("live", category), type = if_else(grepl("NTs", category), "NTs", "cells")) %>%
    select(-category) %>%
    pivot_wider(names_from = "type", values_from = "count") %>%
    mutate(ratio_NT = if_else(cells == 0, 0, NTs / cells)) %>%
    ggplot(aes(x = time, y = ratio_NT)) +
      geom_point(position = position_jitter(width = 0.3), alpha = 0.5) + geom_errorbar(stat = "summary", fun.data = mean_se) + facet_wrap(~condition)  + scale_y_continuous(labels = scales::percent)
}
```


## Do Ampicillin treated cells produce fewer NTs than p-GLG? 

Let us look at total NTs first. Similarly to Figure 2, we will use a binomial generalized linear model. Cells with NTs are treated as success and cells without NTs as failures.

```{r}
#ampicilin_t_90 <- tibble(Replicate = "All", `live cells` = 0, `live cells NTs` = 0, `dying cells` = 614, `dying cells NTs` = 23, condition = "Ampicilin")
ampicilin_t_90 <- data_S8_12 %>% filter(time == "90", condition == "Amp500") %>% mutate(condition = "Ampicilin", Replicate = paste0(replicate, field)) %>% select(-field, -replicate, -time) 

p_glg_t_25 <- p_glg %>% filter(time == "25") %>%
  select(-alive, -time, -type, -alive_string) %>%
  mutate(condition = "P-GLG")



data_fig8 <- rbind(ampicilin_t_90, p_glg_t_25) %>%
  pivot_wider(names_from = "category", values_from = "count") %>%
  mutate(condition = factor(condition, levels = c("P-GLG", "Ampicilin"))) %>%
  mutate(total_cells = `live cells` + `dying cells`,
         total_NTs = `live cells NTs` + `dying cells NTs`) 

fit_fig8_NT <- data_fig8 %>%
  glm(cbind(total_NTs, total_cells - total_NTs) ~ condition, family = "binomial", data = .)

summary(fit_fig8_NT)
```

Significant. And now NTs relative to dying cells:

```{r}
fit_fig8_NT_dying <- data_fig8 %>%
  glm(cbind(`dying cells NTs`, `dying cells` - `dying cells NTs`) ~ condition, family = "binomial", data = .)

summary(fit_fig8_NT_dying)
```

Also significant.

Treatment with Ampicilin led to death of majority of the cells and induced NT formation from dying cells although less frequently than the P-GLG method (p < 0.001). "


## Do number of dying cells change over time?

Here, we treat time as continuous, i.e. we test the overall _trend_ over time, not the difference between individual time points; technically we treat time as a continuous covariate in the model.

```{r}
data_s8_12_model <- data_S8_12 %>%
  pivot_wider(names_from = "category", values_from = "count") %>%
  mutate(total_cells = `live cells` + `dying cells`,
  total_NTs = `live cells NTs` + `dying cells NTs`,
  time_num = as.numeric(time) / 30)

```

First, let us look at the number of dying cells for each condition (live cells treated as success and dying cells as failures):

```{r}
for(condition_to_test in unique(data_s8_12_model$condition)) {
  cat("================================\n\n Condition :", condition_to_test, "\n================================\n\n")
  fit_s8_12_time_dying <- data_s8_12_model %>%
    filter(condition == condition_to_test) %>%
    glm(cbind(total_cells - `dying cells`, `dying cells`) ~  time_num, family = "binomial", data = .)

  print(summary(fit_s8_12_time_dying))
  print(exp(confint((fit_s8_12_time_dying))))
}
```

The Ampicilin condition has no living cells for all time points except t = 0, so we need to regularize by adding 1.

```{r}
fit_s8_12_time_dying_amp_reg <- data_s8_12_model %>%
    filter(condition == "Amp500") %>%
    glm(cbind(total_cells - `dying cells` + 1, `dying cells` + 1) ~  time_num, family = "binomial", data = .)


summary(fit_s8_12_time_dying_amp_reg)
exp(confint(fit_s8_12_time_dying_amp_reg))

```

To be safe, also check with RStanArm:

```{r, message =FALSE, results="hide", cache = TRUE}
fit_s8_12_time_dying_amp_stan <-  data_s8_12_model %>%
  filter(condition == "Amp500") %>%
  rstanarm::stan_glm(cbind(total_cells - `dying cells`, `dying cells`) ~ time_num, family = "binomial", data = ., 
                   prior_intercept = normal(0,10), prior = normal(0,5),
                   warmup = 1000, iter = 6000) # Large number of iterations to accurately sample tails of the distributions
```

```{r}
summary(fit_s8_12_time_dying_amp_stan, probs = c(0.005,0.025, 0.975,0.995))
```


We see significant changes in number of dying cells over time for all but the EmptyLB (no antibiotic) condition (all p < 0.001). The EmptyLB condition is consistent with no change, but we also cannot rule out some noticeable changes.

## Do number of total NTs change over time

Now let us look at the number of total NTs. We test only the Amp500 condition, because other conditions have at most one NT over all fields scanned.

```{r}
  fit_s8_12_time_NT <- data_s8_12_model %>%
    filter(condition == "Amp500") %>%
    glm(cbind(total_NTs, total_cells - total_NTs) ~ time_num, family = "binomial", data = .)
  
  print(summary(fit_s8_12_time_NT))
```

```{r}
  fit_s8_12_time_NT_dying <- data_s8_12_model %>%
    filter(condition == "Amp500") %>%
    glm(cbind(`dying cells NTs`, `dying cells` - `dying cells NTs`) ~ time_num, family = "binomial", data = .)
  
  print(summary(fit_s8_12_time_NT_dying))
  exp(confint(fit_s8_12_time_NT_dying))
```

## Summary

The time trend of the number of dying cells is statistically significant for all antibiotic conditions (all p < 0.001). Time trend of the number of NTs is statistically significant only for Ampicilin (p < 0.001).

# Supplementary Figure 9 - P-GLG vs. Ampicilin

We further compare the proportion of NTs from dying cells in the P-GLG condition (data from Figure 2) and the Ampicilin condition.

```{r}
data_p_GLG_25 <- fig2_data_NT %>% filter(condition == "P-GLG", time == 25) %>% rename(replicate = Replicate) 
data_amp_30 <- data_s8_12_model %>% filter(condition == "Amp500", time == 30) %>% 
  mutate(replicate = paste0(replicate, "-", field)) %>% 
  select(-field, -time_num) 

data_pglg_amp <- rbind(data_p_GLG_25, data_amp_30) %>%
  mutate(condition = factor(condition, levels = c("P-GLG","Amp500")))

fit_pglg_amp <- glm(cbind(`dying cells NTs`, `dying cells`) ~ condition, family = "binomial", data = data_pglg_amp)

summary(fit_pglg_amp)
exp(confint(fit_pglg_amp))
```

After P-GLG treatment, more NTs are created from dying cells than in Ampicilin (p < 0.001).



# Supplementary Figure 10 - Spatial distribution of NTs after Ampicilin treatment

Does the spatial distribution of NTs differ between the wt and ampicilin-treated? Here are the counts for the Ampicilin condition:

```{r}
nt_counts_location_ampicilin <- c("poles" = 0, "septal" = 6, "sides" = 16)
print(nt_counts_location_ampicilin)
```

To refresh, here are the counts from the wild-type condition (Figure 1c):

```{r}
print(nt_counts_location_wt)
```

We run a Chi-squared test to compare those.

```{r}
chisq.test(rbind(nt_counts_location_wt, nt_counts_location_ampicilin), simulate.p.value = TRUE, B = 20000)
```

The distribution of NTs is notably different from that of wild type (p < 0.001).

# Supplementary Figure 14 - Plasmid transfer


```{r}
read_figS14_subset <- function(range, condition) {
  read_dnase_subset(file = "Fig.S14_Primary data_OB.xlsx", sheet = "Fig.S14 chart c", range = range, condition = condition)
}

figS14_data <- rbind(
  read_figS14_subset("A8:F10", "Spc, Cm"),
  read_figS14_subset("L8:Q10", "MLS, Spc"),
  read_figS14_subset("W8:AB10", "MLS, Cm, Spc")
) %>% 
  pivot_longer(cols = c("baseline", "dnase"), names_to = "dnase", values_to = "transformations") %>%
  mutate(
    dnase = if_else(dnase == "dnase", "DNase", "baseline"),
    has_transformations = transformations > 0,
    transformations = if_else(has_transformations, transformations, 1),
    recipients_100 = recipients / 100, ratio = transformations / recipients, ratio_100 = transformations / recipients_100, condition = factor(condition, levels = c("Spc, Cm","MLS, Spc","MLS, Cm, Spc") ))

if(redo_plots) {
  # Showing a variant of Figure S14c, only the DNase- condition, substitutin 1 for zero counts (actually only the `Spc, Cm` condition has non-zero counts)
  bar_base <- 1e-4
  #breaks <- 1e-4 * 2.5^(0:4)
  breaks <- 1e-4 * 10^(0:2)
  
  # Fake bars on log scale
  data_tile <- figS14_data %>%
    rename(has_trans_orig = has_transformations) %>%
    group_by(dnase, condition) %>%
    summarise(
      has_transformations = any(has_trans_orig),
      height = if_else(has_transformations, mean(ratio_100) - bar_base, 0),
      ymax = if_else(has_transformations, mean(log(ratio_100)), log(bar_base)),
      ratio_100 = exp(ymax)
      )
  
  #my_fun <- function(x) { mean( }
  figS14 <- figS14_data %>% 
    mutate(ratio_100 = if_else(has_transformations, ratio_100, bar_base)) %>% #dummy value to not affect the y scale
    ggplot(aes(x = interaction(dnase, condition), y = log(ratio_100), 
               fill = has_transformations, color = has_transformations
               )) + 
      geom_rect(data = data_tile, aes(ymax = ymax, xmin = ..x.. - bar_width / 2, xmax = ..x.. + bar_width / 2), ymin = log(bar_base)) + 
      geom_errorbar(stat = "summary", fun.data = mean_se, width = errorbar_width) + 
      geom_point(position = position_jitter(width = jitter_width, height = 0), size = 2) +
      scale_color_manual(values = c("white","black"), guide = FALSE) +
      scale_fill_manual(values = c("white","#f0f0f0"), guide = FALSE) +
      scale_y_continuous(breaks = log(breaks), labels = breaks, expand = c(0,0)) +
      expand_limits(y = log(1e-2)) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3), panel.border = element_rect(color = NA))
  
  print(figS14)
  ggsave("figs/figS14.pdf", figS14, device = cairo_pdf, width = 5, height = 5.5)
}

```

We model the logarithm of the ratio of transferable as a linear model with condition and DNase presence/absence as covariates (including interaction).

```{r}
fit_figS14_all <- figS14_data %>%
  mutate() %>%
  lm(log(ratio_100) ~ condition * dnase, data = .)

TukeyHSD(aov(fit_figS14_all))
```

All the contrasts of `Spc, Cm` in the baseline (DNase-) condition against everything are significant with p < 0.001. 


# Supplementary Figure 16 - SIM and SEM

## Supplementary Figure 16D
```{r}
data_S16d <- rbind(
  read_condition_sem_quantification("SEM", c("J","K"), condition = "SEM", rows_from = c(2,8,14), rows_to = c(4,11,15), file = "S16d Quantification of NTs in liquid medium.xlsx"),
  read_condition_sem_quantification("SIM", c("G","H"), condition = "SIM", rows_from = c(2,10,15), rows_to = c(7,11,21), file = "S16d Quantification of NTs in liquid medium.xlsx")
) %>%
  mutate(condition = factor(condition, levels = c("SIM","SEM")))

if(redo_plots) {
  data_S16d %>% group_by(condition, replicate) %>%
    summarise(prop_NTs = sum(NTs) / sum(Cells), .groups = "drop") %>%
    group_by(condition) %>%
    summarise(petc_NTs_mean = mean(prop_NTs) * 100, perc_NTs_SEM = sd(prop_NTs) / sqrt(n()) * 100, .groups = "drop")
}

```

We can analyze the difference with a binomial GLM, cells with NTs are treated as success, cells without NTs as failures.

```{r}
fit_S16d <- glm(cbind(NTs, Cells - NTs) ~ condition, data = data_S16d, family = "binomial")
summary(fit_S16d)

```

While the SIM condition has more NTs per cell, the difference is not significant.

## Supplementary Figure 16H

```{r}
data_S16h <- rbind(
  read_condition_sem_quantification("SEM", c("J","L"), condition = "SEM", rows_from = c(3,12,20), rows_to = c(7,15,26), file = "S16h Quantification of NTs on solid medium.xlsx", space = TRUE),
  read_condition_sem_quantification("SIM", c("J","L"), condition = "SIM", rows_from = c(4,7,10), rows_to = c(4,7,10), file = "S16h Quantification of NTs on solid medium.xlsx", space = TRUE)
) %>%
  mutate(condition = factor(condition, levels = c("SIM","SEM")))


if(redo_plots) {
  data_S16h %>% group_by(condition, replicate) %>%
    summarise(prop_NTs = sum(NTs) / sum(Cells), .groups = "drop") %>%
    group_by(condition) %>%
    summarise(petc_NTs_mean = mean(prop_NTs) * 100, perc_NTs_SEM = sd(prop_NTs) / sqrt(n()) * 100, .groups = "drop")
}

```

For analysis with a generalized linear model, we need to regularize, as the SIM condition has no NTs at all. First regularizing by adding one success and one failure to both conditions:

```{r}
fit_S16h_reg <- glm(cbind(NTs + 1, Cells - NTs + 1) ~ condition, data = data_S16h, family = "binomial")
summary(fit_S16h_reg)
exp(confint(fit_S16h_reg))
```

Under this regularization the difference is significant. To be sure let us also check with a Bayesian GLM:

```{r, message=FALSE, results = "hide", cache = TRUE}
fit_S16h_stan <- 
  rstanarm::stan_glm(cbind(NTs, Cells - NTs) ~ condition, family = "binomial", data = data_S16h, 
                     prior_intercept = normal(0,10), prior = normal(0,5),
                     warmup = 1000, iter = 6000) # Large number of iterations to accurately sample tails of the distributions
```

```{r}
summary(fit_S16h_stan, probs = c(0.0005, 0.025, 0.975, 0.9995))

```

Once again the difference is notable - as witnessed by even the 99.9% posterior credible interval being very far from zero. The difference between the SIM and SEM conditions is significant (p < 0.001).


# Original computing environment

```{r}
sessionInfo()
```


